<!DOCTYPE html> 
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cancionero 2025</title>
  <style>
    :root{ --bg:#0f1115; --card:#171923; --muted:#a0aec0; --text:#e2e8f0; --accent:#38bdf8; --accent-2:#22c55e; --border:#2d3250; }
    *{ box-sizing:border-box; } html,body{ margin:0;padding:0;background:var(--bg);color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, Helvetica, Arial;}
    .wrap{ max-width:1150px; margin:24px auto; padding:16px; }
    .title{ font-size:clamp(22px,2.8vw,32px); font-weight:800; display:flex; align-items:center; gap:10px; }
    .pill{ font-size:12px; color:#0f1115; background:linear-gradient(135deg,var(--accent),var(--accent-2)); padding:4px 10px; border-radius:999px; font-weight:700; }
    .toolbar{ display:grid; grid-template-columns:1fr; gap:10px; margin-top:10px; }
    @media (min-width:980px){ .toolbar{ grid-template-columns:1fr 180px 170px 160px 160px 120px; } }
    .search,select,input[type="number"]{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background:#0b0d13; color:#e2e8f0; }
    .meta{ margin:8px 2px 14px; color:var(--muted); font-size:13px; }
    .grid{ display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:680px){ .grid{ grid-template-columns:1fr 1fr; } }
    @media (min-width:1060px){ .grid{ grid-template-columns:1fr 1fr 1fr; } }
    .card{ background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px; display:grid; gap:8px; }
    .topline{ display:flex; align-items:center; justify-content:space-between; gap:10px; }
    .song-title{ font-weight:700; font-size:16px; line-height:1.3; }
    .code{ font-weight:800; font-variant-numeric:tabular-nums; background:#0b0d13; border:1px solid var(--border); padding:4px 8px; border-radius:10px; color:#a5f3fc; }
    .muted{ color:var(--muted); font-size:13px; }
    .actions{ display:flex; flex-wrap:wrap; align-items:center; gap:8px; }
    .btn{ font-size:13px; padding:6px 10px; border-radius:10px; text-decoration:none; color:#e2e8f0; border:1px solid var(--border); background:#0b0d13; }
    .btn.primary{ background:linear-gradient(135deg,#2563eb,#06b6d4); border:none; }
    .no-results{ text-align:center; padding:36px 12px; color:var(--muted); border:1px dashed var(--border); border-radius:16px; margin-top:10px; }
    .right{ display:flex; gap:8px; align-items:center; justify-content:flex-end; }
    .link{ font-size:12px; color:#a5f3fc; text-decoration:none; }
    .hl{ background:rgba(56,189,248,.18); padding:0 2px; border-radius:4px; }
    .splash{ color:var(--muted); font-size:14px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="title">Cancionero 2025 <span class="pill" id="count-pill">–</span></div>

    <!-- === PASO 6 – FORMULARIO DE SOLICITUD (VA AQUÍ, ANTES DE .toolbar) === -->
    <div class="card" style="margin-top:14px;">
      <div class="topline" style="margin-bottom:6px;">
        <div class="song-title">Agregar nueva canción</div>
        <span class="code">SOLICITUD</span>
      </div>
      <form id="addForm" class="actions" style="gap:10px; display:flex; flex-wrap:wrap;">
        <input required id="titleInput" class="search" placeholder="Canción (título)" style="max-width:360px;">
        <input required id="artistInput" class="search" placeholder="Artista" style="max-width:300px;">
        <button id="addBtn" class="btn primary" type="submit">Agregar</button>
        <span id="addMsg" class="muted" role="status" aria-live="polite"></span>
      </form>
    </div>
    <!-- === FIN FORMULARIO === -->

    <div class="toolbar">
      <input class="search" id="q" placeholder="Buscar por título, artista o código..." aria-label="Buscar">
      <select id="artist"><option value="">Todos los artistas</option></select>
      <select id="sort">
        <option value="code_asc">Código (0→9)</option>
        <option value="code_desc">Código (9→0)</option>
        <option value="title_asc">Título (A→Z)</option>
        <option value="title_desc">Título (Z→A)</option>
        <option value="artist_asc">Artista (A→Z)</option>
        <option value="artist_desc">Artista (Z→A)</option>
      </select>
      <select id="links">
        <option value="">Todos los enlaces</option>
        <option value="with">Solo con enlaces</option>
        <option value="no">Solo sin enlaces</option>
      </select>
      <select id="codeRange"><option value="">Rango: todos</option></select>
      <input id="codeExact" type="number" inputmode="numeric" placeholder="Código exacto">
    </div>
    <div class="right" style="margin-top:6px"><a class="link" href="#!" id="clearFilters">Limpiar filtros</a></div>
    <div class="meta" id="meta"></div>
    <div id="grid" class="grid"></div>
    <div id="empty" class="no-results" style="display:none;">No hay resultados para tu búsqueda.</div>
    <div id="splash" class="splash">Cargando canciones…</div>
  </div>

  <!-- Fallback: dataset embebido -->
  <script id="data-embed" type="application/json">[{"title":"Lagrimas de Marmol","artist":"Joaquin Sabina","lyrics_url":"https://www.google.com/search?q=letra+Lagrimas+de+Marmol+Joaquin+Sabina","tabs_url":"https://acordes.lacuerda.net/joaquin_sabina/lagrimas_de_marmol","file_url":"","code":"01001"}, {"title":"Sintiendolo mucho","artist":"Joaquin Sabina","lyrics_url":"https://www.google.com/search?q=letra+Sintiendolo+Mucho+Joaquin+Sabina","tabs_url":"https://acordes.lacuerda.net/joaquin_sabina/sintiendolo_mucho","file_url":"","code":"01002"}, {"title":"Tiramisu de limon","artist":"Joaquin Sabina","lyrics_url":"https://www.google.com/search?q=letra+Tiramisu+de+Limon+Joaquin+Sabina","tabs_url":"https://acordes.lacuerda.net/joaquin_sabina/tiramisu_de_limon","file_url":"","code":"01003"}, {"title":"19 dias y 500 noches","artist":"Joaquin Sabina","lyrics_url":"https://www.google.com/search?q=letra+19+dias+y+500+noches+Joaquin+Sabina","tabs_url":"https://acordes.lacuerda.net/joaquin_sabina/19_dias_y_500_noches","file_url":"","code":"01004"}, {"title":"Contra todo Pronostico","artist":"Joaquin Sabina","lyrics_url":"https://www.google.com/search?q=letra+Contra+todo+pronostico+Joaquin+Sabina","tabs_url":"https://www.google.com/search?q=acordes+Contra+todo+pronostico+Joaquin+Sabina","file_url":"","code":"01005"}, {"title":"Lo niego todo","artist":"Joaquin Sabina","lyrics_url":"https://www.google.com/search?q=letra+Lo+niego+todo+Joaquin+Sabina","tabs_url":"https://chords.lacuerda.net/joaquin_sabina/lo_niego_todo-3.shtml","file_url":"","code":"01006"}, {"title":"Amante Bandido","artist":"Miguel Bosé","lyrics_url":"https://lyricstranslate.com/en/amante-bandido-bandit-lover.html","tabs_url":"https://www.cifraclub.com/bose-miguel/amante-bandido/","file_url":"","code":"1007"}]</script>

  <script>
    const JSON_URL = 'cancionero_2025.json';

    const stripAccents = s => (s || '').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    const norm = s => stripAccents(String(s||'')).toLowerCase();

    const q = document.getElementById('q');
    const artistSel = document.getElementById('artist');
    const sortSel = document.getElementById('sort');
    const linkSel = document.getElementById('links');
    const codeRangeSel = document.getElementById('codeRange');
    const codeExact = document.getElementById('codeExact');
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const meta = document.getElementById('meta');
    const pill = document.getElementById('count-pill');
    const clearFilters = document.getElementById('clearFilters');
    const splash = document.getElementById('splash');

    let DATA = [];
    let BUCKETS = [];

    function makeBuckets(arr){
      const nums = arr.map(x => parseInt(x.code,10)).filter(n => !isNaN(n));
      if(!nums.length){ BUCKETS=[]; return; }
      const cmin=Math.min(...nums), cmax=Math.max(...nums), span=Math.max(1,cmax-cmin+1);
      const opts=[10,25,50,100];
      const size=opts.slice().sort((a,b)=> Math.abs(Math.ceil(span/a)-8)-Math.abs(Math.ceil(span/b)-8))[0];
      const res=[]; for(let a=Math.floor(cmin/size)*size;a<=cmax;a+=size){ res.push([a,a+size-1]); }
      BUCKETS = res;
    }

    function populateSelectors(){
      artistSel.innerHTML = '<option value="">Todos los artistas</option>';
      Array.from(new Set(DATA.map(x=>x.artist).filter(Boolean))).sort((a,b)=>a.localeCompare(b)).forEach(a=>{
        const o=document.createElement('option'); o.value=a; o.textContent=a; artistSel.appendChild(o);
      });
      codeRangeSel.innerHTML = '<option value="">Rango: todos</option>';
      for(const [a,b] of BUCKETS){ const o=document.createElement('option'); o.value=String(a)+'-'+String(b); o.textContent=a+'–'+b; codeRangeSel.appendChild(o); }
      if (DATA.some(x => isNaN(parseInt(x.code,10)))){ const o=document.createElement('option'); o.value='NA'; o.textContent='Sin código'; codeRangeSel.appendChild(o); }
    }

    function highlight(text, query){
      if(!query) return text;
      const safe=query.replace(/[.*+?^${}()|[\]\\]/g,'\\$&').trim(); if(!safe) return text;
      try{ const re=new RegExp('('+safe.split(/\s+/).join('|')+')','gi'); return String(text||'').replace(re,m=>'<span class="hl">'+m+'</span>'); }catch{ return text; }
    }

    function render(){
      const qv = norm(q.value), av=artistSel.value, lv=linkSel.value, rv=codeRangeSel.value, cv=codeExact.value.trim();
      let arr = DATA.slice().filter(x=>{
        if(av && x.artist!==av) return false;
        if(lv==='with' && !(x.lyrics_url||x.tabs_url||x.file_url)) return false;
        if(lv==='no'   &&  (x.lyrics_url||x.tabs_url||x.file_url)) return false;
        if(cv){ const n=parseInt(cv,10), my=parseInt(x.code,10); return !isNaN(n)&&!isNaN(my)&&n===my; }
        else if(rv){ if(rv==='NA') return isNaN(parseInt(x.code,10)); const [a,b]=rv.split('-').map(s=>parseInt(s,10)); const n=parseInt(x.code,10); if(isNaN(a)||isNaN(b)) return true; if(isNaN(n)) return false; if(n<a||n>b) return false; }
        if(!qv) return true;
        const blob = norm([x.code,x.title,x.artist].join(' '));
        return qv.split(/\s+/).filter(Boolean).every(t=>blob.includes(t));
      });

      const s=sortSel.value;
      const cmp=(k,dir=1)=>(a,b)=>{
        if(k==='code'){ const na=parseInt(a.code,10), nb=parseInt(b.code,10);
          if(!isNaN(na)&&!isNaN(nb)) return (na-nb)*dir;
          if(isNaN(na)&&!isNaN(nb)) return 1;
          if(!isNaN(na)&&isNaN(nb)) return -1; }
        const va=String(a[k]??''), vb=String(b[k]??'');
        return va<vb?-1*dir:va>vb?1*dir:0;
      };
      if(s==='code_asc')arr.sort(cmp('code',1));
      if(s==='code_desc')arr.sort(cmp('code',-1));
      if(s==='title_asc')arr.sort(cmp('title',1));
      if(s==='title_desc')arr.sort(cmp('title',-1));
      if(s==='artist_asc')arr.sort(cmp('artist',1));
      if(s==='artist_desc')arr.sort(cmp('artist',-1));

      grid.innerHTML=''; const qRaw=q.value.trim();
      for(const x of arr){
        const card=document.createElement('div'); card.className='card';
        const top=document.createElement('div'); top.className='topline';
        const title=document.createElement('div'); title.className='song-title'; title.innerHTML=highlight(x.title||'(Sin título)', qRaw);
        const badge=document.createElement('div'); badge.className='code'; badge.textContent=(x.code||'—');
        top.appendChild(title); top.appendChild(badge); card.appendChild(top);
        const sub=document.createElement('div'); sub.className='muted'; sub.innerHTML=(x.artist?'· '+highlight(x.artist,qRaw):''); card.appendChild(sub);
        const actions=document.createElement('div'); actions.className='actions';
        if(x.lyrics_url){ const a=document.createElement('a'); a.className='btn primary'; a.textContent='Letra'; a.href=x.lyrics_url; a.target='_blank'; a.rel='noopener noreferrer'; actions.appendChild(a); }
        if(x.tabs_url){ const a=document.createElement('a'); a.className='btn'; a.textContent='Tabs/Acordes'; a.href=x.tabs_url; a.target='_blank'; a.rel='noopener noreferrer'; actions.appendChild(a); }
        if(x.file_url){ const a=document.createElement('a'); a.className='btn'; a.textContent='Archivo'; a.href=x.file_url; a.target='_blank'; a.rel='noopener noreferrer'; actions.appendChild(a); }
        if(!x.lyrics_url && !x.tabs_url && !x.file_url){ const s=document.createElement('span'); s.className='muted'; s.textContent='Sin enlaces'; actions.appendChild(s); }
        card.appendChild(actions); grid.appendChild(card);
      }

      empty.style.display = arr.length ? 'none' : 'block';
      pill.textContent = arr.length + ' canciones';
      const total = DATA.length;
      const af = av ? ' · Artista: “'+av+'”' : '';
      const lf = (lv==='with')?' · Solo con enlaces':(lv==='no')?' · Solo sin enlaces':'';
      const rf = rv ? ' · Rango: '+rv.replace('-', '–') : '';
      const cf = cv ? ' · Código: '+cv : '';
      const qf = q.value ? ' · Búsqueda: “'+q.value+'”' : '';
      meta.textContent = 'Mostrando '+arr.length+' de '+total+' canciones'+af+lf+rf+cf+qf;
    }

    function setupUI(){
      artistSel.innerHTML='<option value="">Todos los artistas</option>';
      Array.from(new Set(DATA.map(x=>x.artist).filter(Boolean))).sort((a,b)=>a.localeCompare(b)).forEach(a=>{
        const o=document.createElement('option'); o.value=a; o.textContent=a; artistSel.appendChild(o);
      });
      codeRangeSel.innerHTML='<option value="">Rango: todos</option>';
      for(const [a,b] of BUCKETS){ const o=document.createElement('option'); o.value=String(a)+'-'+String(b); o.textContent=a+'–'+b; codeRangeSel.appendChild(o); }
      if (DATA.some(x=> isNaN(parseInt(x.code,10)))){ const o=document.createElement('option'); o.value='NA'; o.textContent='Sin código'; codeRangeSel.appendChild(o); }

      q.addEventListener('input', render);
      artistSel.addEventListener('change', render);
      sortSel.addEventListener('change', render);
      linkSel.addEventListener('change', render);
      codeRangeSel.addEventListener('change', render);
      codeExact.addEventListener('input', render);
      clearFilters.addEventListener('click', (e)=>{ e.preventDefault(); q.value=''; artistSel.value=''; sortSel.value='code_asc'; linkSel.value=''; codeRangeSel.value=''; codeExact.value=''; render(); });
    }

    function bootWith(data){
      DATA = (data||[]).map(x=>({ ...x, code: (x.code!=null? String(x.code).trim() : x.code) }));
      makeBuckets(DATA);
      setupUI();
      splash.remove();
      render();
    }

    (function init(){
      const isFile = location.protocol === 'file:';
      if(isFile){
        const txt = document.getElementById('data-embed').textContent || '[]';
        try{ const arr = JSON.parse(txt); bootWith(arr); return; }catch{ /* sigue con fetch como fallback */ }
      }
      fetch(JSON_URL, {cache:'no-store'}).then(r=>r.json()).then(arr=>{
        bootWith(arr);
      }).catch(err=>{
        console.warn('Fetch falló, usando embed:', err);
        const txt = document.getElementById('data-embed').textContent || '[]';
        try{ const arr = JSON.parse(txt); bootWith(arr); }
        catch(e){
          splash.textContent = 'No se pudo cargar el JSON (ni el embebido). Revisa la ruta o vuelve a descargar el archivo.';
          pill.textContent = '0 canciones';
        }
      });
    })();
  </script>

  <!-- === PASO 6 – SCRIPT DEL FORMULARIO (VA AL FINAL, DESPUÉS DEL SCRIPT PRINCIPAL) === -->
  <script>
  (function(){
    const form = document.getElementById('addForm');
    if (!form) return;

    const titleInput = document.getElementById('titleInput');
    const artistInput = document.getElementById('artistInput');
    const addBtn = document.getElementById('addBtn');
    const addMsg = document.getElementById('addMsg');

    async function postJSON(url, data){
      const resp = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      const out = await resp.json().catch(()=> ({}));
      if (!resp.ok) throw new Error(out?.error || 'Error al guardar');
      return out;
    }

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = (titleInput.value || '').trim();
      const artist = (artistInput.value || '').trim();
      if(!title || !artist){
        addMsg.textContent = 'Por favor completa Canción y Artista.';
        return;
      }
      addBtn.disabled = true;
      addMsg.textContent = 'Enviando solicitud…';

      try {
        // Llama a tu endpoint en Vercel
        const out = await postJSON('/api/add-song', { title, artist });
        addMsg.textContent = `Solicitud registrada: ${out?.added?.title} – ${out?.added?.artist} (ID ${out?.added?.code})`;
        form.reset();
      } catch (err) {
        addMsg.textContent = `Error: ${err.message}`;
      } finally {
        addBtn.disabled = false;
      }
    });
  })();
  </script>
  <!-- === FIN SCRIPT FORMULARIO === -->

</body>
</html>
